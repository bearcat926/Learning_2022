# SHOW PROFILES

性能分析工具，用户显示当前会话过程中执行的SQL语句的性能(profiling)信息，可以指定具体的type

## 使用方法

1.此工具默认是禁用的，可以通过服务器变量在会话级别动态修改：`set profiling=1;`，该变量的默认值是0

2.当设置完成之后，可以使用`show profiles;`列出了最近发送到服务端的SQL语句

除 `show profile` 和 `show profiles` 之外，所有sql语句的性能信息都会被记录，甚至包括有错误的语句。

3.show profiles 可以查看的语句列表长度由变量 profiling_history_size 控制，默认值为15，最大值为100。

4.与 MySQL 的命令行模式下只能显示两位小数的时间不同，`show profile` 可以最近一条SQL语句每个步骤的详细执行时间

执行`show profile for query <query_id>;`可以查看某一条的SQL语句信息

5.`show profile` 和 `show profiles` 命令同时也支持 LIMIT 语句

## 类型

### all

显示所有性能信息

`show profile all for query n`

### block io

显示块io操作的次数

`show  profile block io for query n`

### context switches

显示上下文切换次数，被动和主动

`show profile context switches for query n`

### cpu

显示用户cpu时间、系统cpu时间

`show profile cpu for query n`

### IPC

显示发送和接受的消息数量

`show profile ipc for query n`

### Memory（暂未实现）

### page faults

显示页错误数量

`show profile page faults for query n`

### source

显示源码中的函数名称与位置

`show profile source for query n`

### swaps

显示swap的次数

`show profile swaps for query n`

## 直接查询 Information_schema 中的 profiling 表 （转图片）

set @querd_id = 1;

SELECT STATE, SUM(DURATION) AS Total_R,

ROUND(

100 * SUM(DURATION) / 

(SELECT SUM(DURATION)

FROM INFORMATION_SCHEMA.PROFILING

WHERE QUERY_ID = @query_id)

, 2) AS Pct_R,

COUNT(*) AS Calls,

SUM(DURATION) / COUNT(*) AS 'R/Call'

FROM INFORMATION_SCHEMA.PROFILING

WHERE QUERY_ID = @query_id

GROUP BY STATE

ORDER BY Total_R DESC;

# performance schema

MySQL的 performance schema 用于监控MySQL server在一个较低级别的运行过程中的资源消耗、资源等待等情况。

# show processlist

查看连接的线程数，可以用来观察是否有大量线程处于不正常的状态或者其他不正常的特征

## 属性说明

### id

session id

### user

操作的用户

### host

操作的主机

### db

操作的数据库

### command

当前状态

#### sleep

线程正在等待客户端发送新的请求

#### query

线程正在执行查询或正在将结果发送给客户端

#### locked

在mysql的服务层，该线程正在等待表锁

#### analyzing and statistics

线程正在收集存储引擎的统计信息，并生成查询的执行计划

#### Copying to tmp table

线程正在执行查询，并且将其结果集都复制到一个临时表中

#### sorting result

线程正在对结果集进行排序

#### sending data

线程可能在多个状态之间传送数据，或者在生成结果集或者向客户端返回数据

### info

详细的sql语句

### time

相应命令执行时间

### state

命令执行状态
