# 客户端与服务器连接的过程「」$

## 通信方式

### 命名管道和共享内存（Windows ）

使用「命名管道」来进行进程间通信，需要在启动服务器的命令中加上`--enable-named-pipe`参数，然后在启动客户端的命令中加入`--pipe`或者`--protocol=pipe`参数。

使用「共享内存」来进行进程间通信，需要在启动服务器的命令中加上`--shared-memory`参数，在成功启动服务器后， 共享内存便成为本地
客户端的默认连接方式，也可以在启动客户端的命令中加入`--protocol=memory `参数来显式指定；需要注意，使用「共享内存」进行通信的服务器进程和客户端进程必须在同一台 Windows 主机中。

### Socket（Unix）

需要满足服务器进程和客户端进程都运行在同一台类 Unix 操作系统的机器上。

在启动客户端的时候指定的主机名为`localhost`，或者指定了`--protocol=socket`的启动参数。

MySQL 服务器默认监听的 UNIX 域套接字文件路径为`/tmp/mysql.sock`，可以在启动服务器时指定 socket 参数 `--socket=/tmp/a.txt`；修改该参数后，客户端想通过 UNIX 域套接字文件进行通信的话，也需要显式指定该 socket 参数。

## 服务器处理客户端请求

服务器处理来自客户端的查询请求需要经过连接管理、解析优化、存储引擎三个部分。

### 1. 连接管理

1. 客户端连接到服务器时，服务器会创建一个线程来专门处理与这个客户端的交互
2. 客户端退出时会与服务器断开连接，但服务器并不会立即把与该客户端交互的线程销毁掉，而是把它缓存起来，在另一个新的客户端再进行连接时，把这个缓存的线程分配给该新客户端（**连接池**）

### 2. 解析优化

#### 2.1 查询缓存

MySQL 服务器会把刚刚处理过的查询请求和结果缓存起来。

**缓存未命中**：如果两次查询请求在任何字符上的不同（例如：空格、注释、大小写）。

**不会缓存**：如果查询请求中包含某些系统函数、用户自定义变量和函数、一些系统表（如`mysql`、`information_schema`、`performance_schema`数据库中的表），那这个请求就不会被缓存；例如`now`。

**缓存失效**：如果某张表 A 的结构或者数据被修改，如对表 A 使用了`INSERT`、`UPDATE`、`DELETE`、`TRUNCATE TABLE`、`ALTER TABLE`、`DROP TABLE`或`DROP DATABASE`语句，那使用表 A 的所有高速缓存查询都将变为无效并从高速缓存中删除！这种机制是通过缓存系统会监测涉及到的每张表实现的。

从MySQL 5.7.20 开始，不推荐使用查询缓存，并在MySQL 8.0中删除。

#### 2.2 语法解析

本质上算是一个编译过程，涉及词法解析、语法分析、语义分析等阶段，在这个过程中会判断请求的语法是否正确。

#### 2.3 查询优化

MySQL 把数据的存储和提取操作都封装到了一个叫存储引擎的模块里

# 启动选项和系统变量

## 启动选项

### 命令行配置

查看 mysql 支持的启动选项需要使用`mysql --help`

查看 mysqld_safe 支持的启动选项需要使用`mysqld_safe --help`

查看 mysqld 支持的启动选项需要使用`mysqld --verbose --help`

### 配置文件

#### Windows操作系统

|路径名|备注|
|-|-|
|`%WINDIR%\my.ini`，`%WINDIR%\my.cnf`| 机器上 Windows 目录的位置 |
|`C:\my.ini`，`C:\my.cnf`| |
|`BASEDIR\my.ini`，`BASEDIR\my.cnf`| MySQL 安装目录的路径 |
|`--defaults-extra-file`|命令行指定的额外配置文件路径|
|`%APPDATA%\MySQL\.mylogin.cnf`|Windows 应用程序数据目录（**客户端**启动选项，加密文件）|

#### 类UNIX 操作系统

|路径名|备注|
|-|-|
|`/etc/my.cnf`| |
|`/etc/mysql/my.cnf`| |
|`SYSCONFDIR/my.cnf`| 使用 CMake 构建 MySQL 时，会使用 SYSCONFDIR 选项指定的目录（默认为`/etc`） |
|`$MYSQL_HOME/my.cnf`|环境变量，特定于**服务器**的选项|
|`--defaults-extra-file`|命令行指定的额外配置文件路径|
|`~/.my.cnf`|用户目录特定选项|
|`~/.mylogin.cnf`|用户目录特定选项（**客户端**启动选项，加密文件）|

#### 内容

|启动命令|类别|能读取的组|
|-|-|-|
|mysqld|服务器|[mysqld] 、[server]|
|mysqld_safe|服务器|[mysqld] 、[server] 、[mysqld_safe]|
|mysql.server|服务器|[mysqld] 、[server] 、[mysql.server]|
|mysql|客户端|[mysql] 、[client]|
|mysqladmin|客户端|[mysqladmin] 、[client]|
|mysqldump|客户端|[mysqldump] 、[client]|

特定MySQL版本的专用选项组：[mysqld-5.7]

#### 优先级

如果**在多个配置文件中设置了相同的启动选项**，那以最后一个配置文件中的为准；

如果**在同一配置文件的多个组中设置了相同的启动选项**，那以最后一个出现的组中的启动选项为准；

如果不想让 MySQL 到默认的路径下搜索配置文件，可以在命令行**指定默认配置文件**`--defaults-file=<config_file_path>`；

如果同一个启动选项既出现在命令行中，又出现在配置文件中，那么**以命令行中的启动选项为准**！

## 系统变量

### 查看

`SHOW VARIABLES [LIKE 匹配的模式];`

### 设置

#### 通过启动选项设置

对于启动选项来说，各个单词之间可以用短划线`-`或者下划线`_`连接，但是对应的系统变量必须使用下划线`_`连接

#### 服务器运行过程中设置

大部分系统变量都可以在服务器运行过程中进行动态修改而无需停止并重启服务器。

可以通过客户端命令`SET [GLOBAL|SESSION] 系统变量名 = 值;`设置；或者`SET [@@(GLOBAL|SESSION).]var_name = XXX;`

### 不同作用范围的系统变量

#### 设置

作用范围分为两种：GLOBAL，全局变量，影响服务器的整体操作；SESSION，会话变量，影响某个客户端连接的操作（注：SESSION 有个别名叫 LOCAL）

通过启动选项设置的系统变量的作用范围都是 GLOBAL 的，也就是对所有客户端都有效的；如果在设置系统变量的语句中省略了作用范围，默认的作用范围就是SESSION 

#### 查看

`SHOW [GLOBAL|SESSION] VARIABLES [LIKE 匹配的模式];`

默认查看的是 SESSION 作用范围的系统变量

#### 注意

并不是所有系统变量都具有GLOBAL 和SESSION 的作用范围：

1. 有一些系统变量只具有 GLOBAL 作用范围，比如`max_connections`，表示服务器程序支持同时最多有多少个客户端程序进行连接。
2. 有一些系统变量只具有 SESSION 作用范围，比如`insert_id`，表示在对某个包含 AUTO_INCREMENT 列的表进行插入时，该列初始的值。

有些系统变量是只读的，并不能设置值：

比方说`version`，表示当前MySQL 的版本，客户端是不能设置它的值的，只能在`SHOW VARIABLES`语句里查看。

### 启动选项和系统变量的区别

启动选项是在程序启动时程序员传递的一些参数，而系统变量是影响服务器程序运行行为的变量

## 状态变量

状态变量是用来显示服务器程序运行状况的，所以它们的值只能由服务器自己来设置，程序员是不能设置的。

### 查看

`SHOW [GLOBAL|SESSION] STATUS [LIKE 匹配的模式];`

默认查看的是 SESSION 作用范围的状态变量

# 字符集和比较规则

## 字符集

要把哪些字符映射成二进制数据？：界定清字符范围

怎么映射？：将一个字符映射成一个二进制数据的过程叫做**编码**；将一个二进制数据映射到一个字符的过程叫做**解码**。

某个字符范围的编码规则就叫做**字符集**

## 比较规则

针对某个字符集中的字符比较大小的一种规则；同一种字符集可以有多种比较规则

## MySQL中支持的字符集和排序规则

### MySQL中的 utf8 和 utf8mb4

utf8（utf8mb3）：阉割过的 utf8 字符集，只使用1～3个字节表示字符。
utf8mb4：正宗的 utf8 字符集，使用1～4个字节表示字符。

### 查看支持的字符集

`SHOW (CHARACTER SET|CHARSET) [LIKE 匹配的模式];`

### 查看比较规则

`SHOW COLLATION [LIKE 匹配的模式];`

## 应用

### 各级别的字符集和比较规则

#### 服务器级别

通过启动选项或者使用 SET 语句修改系统变量

#### 数据库级别

创建和修改数据库的时候可以指定，默认使用服务器级别的字符集和比较规则

#### 表级别

创建和修改表的时候指定，默认使用该表所在数据库的字符集和比较规则

#### 列级别

在创建和修改列定义的时候可以指定，默认使用该列所在表的字符集和比较规则

#### 仅修改字符集或仅修改比较规则

只修改字符集，则比较规则将变为修改后的字符集默认的比较规则。
只修改比较规则，则字符集将变为修改后的比较规则对应的字符集。

### 客户端和服务器通信中的字符集

#### 编码和解码使用的字符集不一致的后果 - 乱码

#### MySQL中的字符集转换

从发送请求到返回结果这个过程中伴随着多次字符集的转换，在这个过程中会用到3个系统变量：

|系统变量|描述|
|-|-|
|character_set_client|服务器解码客户端请求时使用的字符集（即服务器认为客户端发送过来的请求是用character_set_client 编码的）|
|character_set_connection|服务器处理请求时，会把请求字符串的字符集从`character_set_client`为转为`character_set_connection`|
|character_set_results|服务器向客户端返回数据时使用的字符集（即服务器认为客户端接收的响应是用 character_set_results 编码的）|

##### 过程

![流程图]()

1. 客户端使用「操作系统的字符集」编码请求字符串，向服务器发送一个经过编码的字节串。
2. 服务器将客户端发送来的字节串采用「character_set_client 的字符集」进行解码，将解码后的字符串再按照「character_set_connection 的字符集」进行编码。
3. 如果「character_set_connection 的字符集」和具体操作的「列使用的字符集」一致，则直接进行相应操作；否则的话需要将请求中的字符串从「character_set_connection 的字符集」转换为具体操作的「列使用的字符集」后再进行操作。
4. 将从某个列获取到的字节串从「列使用的字符集」转换为「character_set_results 的字符集」后发送到客户端。
5. 客户端使用「操作系统的字符集」解析收到的结果集字节串。

##### 设置

通过`SET NAMES 字符集名;`可以将三个变量设置成一致的字符集；配置启动选项`default-character-set`也能达到一样的效果

### 比较规则的应用

使用`ORDER BY`语句进行排序

# InnoDB 记录结构

## 页

InnoDB 是一个将表中的数据存储到磁盘上的存储引擎；但其真正处理数据的过程是发生在内存中的，所以需要把磁盘中的数据加载到内存中；如果处理写入或修改请求的话，还需要把内存中的内容刷新到磁盘上。

如何处理内存与磁盘间的速度差距

将数据划分为若干个页，以页作为磁盘和内存之间交互的基本单位，InnoDB中页的大小一般为 16 KB

即在一般情况下，每次读取最少将磁盘中16KB的内容读取到内存中，每次写入最少把内存中的16KB内容刷新到磁盘中

## 行格式

我们平时是以记录为单位来向表中插入数据的，这些记录在磁盘上的存放方式也被称为「行格式」或者「记录格式」

### 设置

创建或修改表的语句中指定行格式：`CREATE TABLE 表名 (列信息) ROW_FORMAT=行格式名称`或`ALTER TABLE 表名 ROW_FORMAT=行格式名称`

### 类型

#### Compact

![Compact 示意图]()

一条完整的记录被分为记录的「额外信息」和记录的「真实数据」

#### Redundant

#### Dynamic

#### Compressed
